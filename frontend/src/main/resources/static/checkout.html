<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Book Store - Checkout</title>
    <link href="images/logo.png" rel="shortcut icon" />
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous" />
    <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous" />
     <link href="css/style.css" rel="stylesheet" />
     <script src="js/config.js"></script>
     <script src="js/auth.js"></script>
     <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
</head>

<body>
<nav class="navbar navbar-dark bg-dark">
    <a class="navbar-brand" href="/">Book Store</a>
    <a class="navbar-brand" href="/cart.html">Cart</a>
    <a class="navbar-brand" href="/list.html">Admin</a>
</nav>

<div class="container" id="main-content">

    <div class="row">
        <div class="col-3 no-padding mb-5">
            <a class="btn btn-primary" href="/cart.html">
                <i class="fa fa-arrow-left"></i> BACK TO CART
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col">
            <form id="checkout-form">
                <h4 class="text-center">Billing Details</h4>

                <div class="alert alert-danger" role="alert" id="error-message" style="display: none;">
                </div>

                <div class="row">
                    <div class="form-group col">
                        <input class="form-control" type="text" placeholder="Name" id="name" />
                    </div>
                    <div class="form-group col">
                        <input class="form-control" type="text" placeholder="Surname" id="surname" />
                    </div>
                </div>
                <div class="form-group">
                    <input class="form-control" type="text" placeholder="Country/Region" id="countryRegion" />
                </div>
                <div class="form-group">
                    <input class="form-control" type="text" placeholder="Street and house number" id="streetAndHouseNumber" />
                </div>
                <div class="form-group">
                    <input class="form-control" type="text" placeholder="City" id="city" />
                </div>
                <div class="form-group">
                    <input class="form-control" type="text" placeholder="Postal code" id="postalCode" />
                </div>
                <div class="form-group">
                    <input class="form-control" type="text" placeholder="Phone number" id="phoneNumber" />
                </div>
                <div class="form-group">
                    <input class="form-control" type="text" placeholder="Email" id="email" />
                </div>

                <div class="form-group">
                    <button type="submit" class="btn btn-block btn-primary">
                        <i class="fa fa-check"></i> Place order
                    </button>
                </div>
            </form>
        </div>

        <div class="col">
            <h4 class="text-center">Your order</h4>
            <div class="row">
                <div class="col">
                    <h5>Products</h5>
                    <ul class="list-unstyled" id="product-list">
                    </ul>
                </div>
                <div class="col">
                    <h5>In total</h5>
                    <ul class="list-unstyled" id="price-list">
                    </ul>
                </div>
            </div>
            <div class="row" style="margin-top: 25px;">
                <div class="col">
                    <h5>Delivery</h5>
                </div>
                <div class="col">
                    <h5 id="shipping-cost">...</h5>
                </div>
            </div>
            <div class="row" style="margin-top: 25px;">
                <div class="col">
                    <h5>In total</h5>
                </div>
                <div class="col">
                    <h5 id="total-price">...</h5>
                </div>
            </div>
            <div class="row" style="margin-top: 25px;">
                <div class="col">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="payment" id="radioOption1" value="card">
                        <label class="form-check-label" for="radioOption1"> Payment by card </label>
                    </div>
                </div>
                <div class="col">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="payment" id="radioOption2" value="cash" checked>
                        <label class="form-check-label" for="radioOption2"> Cash on delivery </label>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<footer class="container" style="padding: 50px;">
    <strong>&copy; <a href="https://github.com/crni99/" target="_blank">github/crni99</a></strong>
</footer>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const checkoutForm = document.getElementById('checkout-form');
        const errorMsg = document.getElementById('error-message');

        // Order Summary Elements
        const productList = document.getElementById('product-list');
        const priceList = document.getElementById('price-list');
        const shippingCostEl = document.getElementById('shipping-cost');
        const totalPriceEl = document.getElementById('total-price');

        let cartProducts = []; // Store cart products for submission

        const CART_API_URL = window.APP_CONFIG.BACKEND_URL + '/carts';
        const CHECKOUT_API_URL = window.APP_CONFIG.BACKEND_URL + '/api/orders';

        // --- 1. Load Order Summary on Page Load ---
        async function loadOrderSummary() {
            try {
                // Fetch all data in parallel
                 const [cartRes, totalRes, shippingRes] = await Promise.all([
                     window.AuthUtils.authenticatedFetch(CART_API_URL),
                     window.AuthUtils.authenticatedFetch(CART_API_URL + '/total'),
                     window.AuthUtils.authenticatedFetch(CART_API_URL + '/shipping-cost')
                 ]);

                if (!cartRes.ok || !totalRes.ok || !shippingRes.ok) {
                    showError('Could not load order summary. Please go back to the cart.');
                    return;
                }

                // Process data
                const products = await cartRes.json();
                const total = await totalRes.json();
                const shipping = await shippingRes.text(); // Assuming it returns a plain string

                cartProducts = products; // Store for submission

                // Render data
                renderCartSummary(products);
                shippingCostEl.textContent = `${shipping} $`;
                totalPriceEl.textContent = `${total} $`;

            } catch (error) {
                console.error('Error loading summary:', error);
                showError('Could not connect to server.');
            }
        }

        // --- 2. Helper to render product lists ---
        function renderCartSummary(products) {
            productList.innerHTML = '';
            priceList.innerHTML = '';

            if (!products || products.length === 0) {
                window.location.href = '/cart.html'; // Redirect if cart is empty
            }

            products.forEach(book => {
                productList.innerHTML += `<li>${book.name}</li>`;
                priceList.innerHTML += `<li>${book.price} $</li>`;
            });
        }

        // --- 3. Handle Form Submission ---
        checkoutForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            errorMsg.style.display = 'none';

            // Gather customer data
            const customerData = {
                name: document.getElementById('name').value,
                surname: document.getElementById('surname').value,
                countryRegion: document.getElementById('countryRegion').value,
                streetAndHouseNumber: document.getElementById('streetAndHouseNumber').value,
                city: document.getElementById('city').value,
                postalCode: document.getElementById('postalCode').value,
                phoneNumber: document.getElementById('phoneNumber').value,
                email: document.getElementById('email').value
            };

            // Gather payment method
            const paymentMethod = document.querySelector('input[name="payment"]:checked').value;

            // Combine into one payload
            const orderData = {
                customer: customerData,
                books: cartProducts
            };

            try {
                const response = await window.AuthUtils.authenticatedFetch(CHECKOUT_API_URL, {
                     method: 'POST',
                     headers: { 'Content-Type': 'application/json' },
                     body: JSON.stringify(orderData)
                 });

                if (response.ok) {
                    // Success! Redirect to an "order success" or "my orders" page.
                    // Assuming you will create an 'orders.html' page:
                    alert('Order placed successfully!');
                    window.location.href = '/orders.html';
                } else if (response.status === 400) {
                    const errors = await response.json();
                    showError('Validation failed.', errors);
                } else {
                    showError('Failed to place order. Please try again.');
                }
            } catch (error) {
                console.error('Submit error:', error);
                showError('Could not connect to server.');
            }
        });

        // --- 4. Helper function for errors ---
        function showError(message, errors = null) {
            let html = `<strong>${message}</strong>`;
            if (errors && typeof errors === 'object') {
                html += '<ul>';
                for (const key in errors) {
                    html += `<li>${key}: ${errors[key]}</li>`;
                }
                html += '</ul>';
            }
            errorMsg.innerHTML = html;
            errorMsg.style.display = 'block';
        }

        // --- Initial Load ---
        loadOrderSummary();
    });
</script>
</body>
</html>