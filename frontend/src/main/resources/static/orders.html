<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Book Store - Orders</title>
    <link href="images/logo.png" rel="shortcut icon" />
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous" />
    <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous" />
    <link href="css/style.css" rel="stylesheet" />
    <script src="js/config.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
</head>

<body>
    <nav class="navbar navbar-dark bg-dark">
        <a class="navbar-brand" href="/">Book Store</a>
        <a class="navbar-brand" href="/cart.html">Cart</a>
        <a class="navbar-brand" href="/list.html">Admin</a>
    </nav>

    <div class="container" id="main-content">
        <div class="row">
            <div class="col-4 no-padding">
                <form class="form-inline" id="search-form">
                    <input class="form-control mr-sm-2" type="search" name="term" id="search-term"
                           placeholder="Search by date ..." />
                    <button class="btn btn-primary" type="submit">
                        <i class="fa fa-search"></i> Search
                    </button>
                </form>
            </div>
            <div class="col-4 no-padding">
                <a href="/book.html" class="btn btn-info float-right">
                    <i class="fa fa-list-ul"></i> Admin
                </a>
            </div>
            <div class="col-4 no-padding">
                <button id="auth-btn" class="btn btn-danger float-right">
                    <i class="fa fa-key"></i> <span id="auth-text">Log out</span>
                </button>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12 alert alert-success alert-dismissible fade show" role="alert" id="success-message" style="display: none;">
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="col-12 alert alert-danger" role="alert" id="error-message" style="display: none;">
            </div>

            <div id="no-orders-message" style="display: none;">
                <h5>There are no current orders.</h5>
            </div>

            <div class="table-responsive" id="orders-container" style="display: none;">
                <h5>List of orders</h5>
                <table class="table table-striped table-dark text-nowrap">
                    <thead>
                        <tr>
                            <th>Customer ID</th>
                            <th>Name</th>
                            <th>Surname</th>
                            <th>Country/Region</th>
                            <th>Street and house number</th>
                            <th>City</th>
                            <th>Postal code</th>
                            <th>Phone number</th>
                            <th>Email</th>
                        </tr>
                    </thead>
                    <tbody id="orders-table">
                    </tbody>
                </table>
                <h5>&nbsp;</h5>
            </div>

            <nav aria-label="Page navigation">
                <ul class="pagination" id="pagination-container">
                </ul>
            </nav>
        </div>
    </div>

    <footer class="container" style="padding: 50px;">
        <strong>&copy; <a href="https://github.com/crni99/" target="_blank">github/crni99</a></strong>
    </footer>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const ordersContainer = document.getElementById('orders-container');
        const ordersTable = document.getElementById('orders-table');
        const paginationContainer = document.getElementById('pagination-container');
        const searchForm = document.getElementById('search-form');
        const searchTermInput = document.getElementById('search-term');
        const noOrdersMsg = document.getElementById('no-orders-message');
        const successMsg = document.getElementById('success-message');
        const errorMsg = document.getElementById('error-message');

        // API Endpoints
        const ORDERS_API_URL = window.APP_CONFIG.BACKEND_URL + '/orders';

        // --- 1. Main Function: Fetch and Render Orders ---
        async function fetchOrders(page = 0, size = 10, term = '') {
            // Clear old content and messages
            ordersTable.innerHTML = '';
            paginationContainer.innerHTML = '';
            ordersContainer.style.display = 'none';
            noOrdersMsg.style.display = 'none';
            successMsg.style.display = 'none';
            errorMsg.style.display = 'none';

            // Build query URL
            const url = new URL(ORDERS_API_URL);
            url.searchParams.append('page', page);
            url.searchParams.append('size', size);
            if (term) {
                url.searchParams.append('term', term);
            }

            try {
                const response = await fetch(url.toString(), {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const orderPage = await response.json(); // Expects Spring Page<> object

                    if (orderPage && orderPage.content && orderPage.content.length > 0) {
                        renderOrders(orderPage.content);
                        renderPagination(orderPage);
                        ordersContainer.style.display = 'block';
                    } else {
                        noOrdersMsg.style.display = 'block';
                    }
                } else {
                    showError('Could not load orders. Please try again.');
                }
            } catch (error) {
                console.error('Fetch error:', error);
                showError('Could not connect to the server.');
            }
        }

        // --- 2. Helper: Render Orders Table ---
        function renderOrders(orders) {
            orders.forEach(order => {
                const rowHtml = `
                    <tr>
                        <td>${order.customer ? order.customer.id : ''}</td>
                        <td>${order.customer ? order.customer.name : ''}</td>
                        <td>${order.customer ? order.customer.surname : ''}</td>
                        <td>${order.customer ? order.customer.countryRegion : ''}</td>
                        <td>${order.customer ? order.customer.streetAndHouseNumber : ''}</td>
                        <td>${order.customer ? order.customer.city : ''}</td>
                        <td>${order.customer ? order.customer.postalCode : ''}</td>
                        <td>${order.customer ? order.customer.phoneNumber : ''}</td>
                        <td>${order.customer ? order.customer.email : ''}</td>
                    </tr>
                `;
                ordersTable.innerHTML += rowHtml;
            });
        }

        // --- 3. Helper: Render Pagination ---
        function renderPagination(orderPage) {
            if (orderPage.totalPages <= 1) return;

            for (let i = 0; i < orderPage.totalPages; i++) {
                const pageNum = i;
                const li = document.createElement('li');
                li.className = `page-item font-weight-bold ${pageNum === orderPage.number ? 'active' : ''}`;

                const a = document.createElement('a');
                a.className = 'page-link';
                a.href = '#';
                a.textContent = pageNum + 1; // Show 1-based index
                a.dataset.page = pageNum;

                li.appendChild(a);
                paginationContainer.appendChild(li);
            }
        }

        // --- 4. Event Listeners ---

        // Search
        searchForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const term = searchTermInput.value;
            fetchOrders(0, 10, term);
        });

        // Pagination
        paginationContainer.addEventListener('click', function(e) {
            e.preventDefault();
            if (e.target.tagName === 'A' && e.target.dataset.page) {
                const page = e.target.dataset.page;
                const term = searchTermInput.value;
                fetchOrders(page, 10, term);
            }
        });

        // --- Helper functions for messages ---
        function showError(message) {
            errorMsg.textContent = message;
            errorMsg.style.display = 'block';
        }

        function showSuccess(message) {
            successMsg.firstChild.nodeValue = message; // Set text
            successMsg.style.display = 'block';
        }

        // Authentication check function
        function checkAuth() {
            const accessToken = getCookie('access token');
            const authBtn = document.getElementById('auth-btn');
            const authText = document.getElementById('auth-text');

            if (accessToken) {
                // User is logged in - show logout
                authText.textContent = 'Logout';
                authBtn.onclick = function() {
                    logout();
                };
            } else {
                // User is not logged in - show login
                authText.textContent = 'Login';
                authBtn.onclick = function() {
                    window.location.href = '/login.html';
                };
            }
        }

        // Logout function
        async function logout() {
            try {
                const response = await fetch(window.APP_CONFIG.BACKEND_URL + '/logout', {
                    method: 'POST',
                    credentials: 'include'
                });

                if (response.ok) {
                    // Clear cookie and redirect
                    document.cookie = 'access token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                    window.location.href = '/login.html';
                } else {
                    showError('Logout failed.');
                }
            } catch (error) {
                showError('Connection error during logout.');
            }
        }

        // Helper function to get cookie
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        // --- Initial Load ---
        fetchOrders(); // Load first page
        checkAuth(); // Check authentication state
    });
    </script>
</body>
</html>