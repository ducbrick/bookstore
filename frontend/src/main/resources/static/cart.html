<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Book Store - Cart</title>
    <link href="images/logo.png" rel="shortcut icon" />
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous" />
    <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous" />
    <link href="css/style.css" rel="stylesheet" />
    <script src="js/config.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
</head>

<body>
<nav class="navbar navbar-dark bg-dark">
    <a class="navbar-brand" href="/">Book Store</a>
    <a class="navbar-brand" href="/cart">Cart</a>
    <a class="navbar-brand" href="/book">Admin</a>
</nav>

<div class="container" id="main-content">
    <div class="row h-100">
        <div class="col-4 no-padding">
            <button class="btn btn-primary" id="checkout-btn">
                <i class="fa fa-cart-arrow-down fa-bigger"></i> CHECKOUT
            </button>
        </div>
        <div class="col-4 no-padding" style="display: flex; justify-content: center;">
            <h4 id="total-price" class="align-middle" style="line-height: 2.5em;"></h4>
        </div>
        <div class="col-4 no-padding d-flex justify-content-end">
            <button class="btn btn-danger" id="delete-all-btn">
                <i class="fa fa-trash-o fa-bigger"></i> DELETE ALL
            </button>
        </div>
    </div>
    <div class="row mt-4">
        <div class="col-12 alert alert-success alert-dismissible fade show" role="alert" id="success-message" style="display: none;">
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <div class="col-12 alert alert-danger" role="alert" id="error-message" style="display: none;"></div>
        <div id="empty-cart-message" style="display: none;">
            <h5>Your basket is currently empty.</h5>
        </div>

        <div class="card-deck" id="cart-items-container" style="display: flex; justify-content: space-around; margin-top: 20px;">
        </div>
    </div>
</div>

<footer class="container" style="padding: 50px;">
    <strong>&copy; <a href="https://github.com/crni99/" target="_blank">github/crni99</a></strong>
</footer>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const cartContainer = document.getElementById('cart-items-container');
        const emptyCartMsg = document.getElementById('empty-cart-message');
        const successMsg = document.getElementById('success-message');
        const errorMsg = document.getElementById('error-message');
        const checkoutBtn = document.getElementById('checkout-btn');
        const deleteAllBtn = document.getElementById('delete-all-btn');
        const totalDisplay = document.getElementById('total-price');

        const API_URL = window.APP_CONFIG.BACKEND_URL + '/carts';

        // --- 1. Main Function: Fetch and Render Cart ---
        async function fetchCart() {
            // Clear old data and messages
            cartContainer.innerHTML = '';
            totalDisplay.textContent = '';
            emptyCartMsg.style.display = 'none';
            successMsg.style.display = 'none';
            errorMsg.style.display = 'none';

            try {
                // UPDATED: Fetches from /carts (GET)
                const response = await fetch(API_URL, {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const cartItems = await response.json();

                    if (cartItems && cartItems.length > 0) {
                        renderCartItems(cartItems);
                        fetchTotalPrice(); // NEW: Fetch total price
                        checkoutBtn.style.display = 'block';
                        deleteAllBtn.style.display = 'block';
                    } else {
                        emptyCartMsg.style.display = 'block';
                        checkoutBtn.style.display = 'none';
                        deleteAllBtn.style.display = 'none';
                    }
                } else {
                    showError('Could not load your cart. Please try again.');
                }
            } catch (error) {
                console.error('Fetch error:', error);
                showError('Could not connect to the server.');
            }
        }

        // --- 2. Helper: Fetch Total Price ---
        // NEW function to use your /carts/total endpoint
        async function fetchTotalPrice() {
            try {
                const response = await fetch(API_URL + '/total', {
                    method: 'GET',
                    credentials: 'include'
                });
                if (response.ok) {
                    const total = await response.json();
                    totalDisplay.textContent = `Total: ${total} $`;
                }
            } catch (error) {
                console.error('Total price fetch error:', error);
            }
        }

        // --- 3. Helper: Build HTML for Cart Items (No changes needed) ---
        function renderCartItems(items) {
            cartContainer.innerHTML = ''; // Clear container
            items.forEach(book => {
                const cardHtml = `
                    <div class="col-sm-6" style="max-width: 32rem; display: inline-table; width: 32rem;">
                        <div class="card text-white bg-dark" style="width: 32rem; margin-bottom: 50px">
                            <div class="card-body">
                                <h5 class="card-title">${book.name}</h5>
                                <p class="card-text">${book.authors}</p>
                            </div>
                            <div class="card-footer" style="display: inline">
                                <i class="font-weight-bold align-middle">${book.price} $</i>
                                <button class="btn btn-danger remove-btn" data-book-id="${book.id}" style="float: right">
                                    <i class="fa fa-minus-circle"></i> Remove from cart
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                cartContainer.innerHTML += cardHtml;
            });
        }

        // --- 4. Event Listeners ---

        // "Remove one item"
        cartContainer.addEventListener('click', async function(e) {
            const removeButton = e.target.closest('.remove-btn');
            if (removeButton) {
                const bookId = removeButton.dataset.bookId;
                try {
                    // UPDATED: Uses DELETE /carts/{id}
                    const response = await fetch(`${API_URL}/${bookId}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    });

                    if (response.ok) {
                        showSuccess('Item removed from cart.');
                        fetchCart(); // Reload the cart
                    } else {
                        showError('Failed to remove item.');
                    }
                } catch (error) {
                    showError('Connection error.');
                }
            }
        });

        // "Delete All" button
        deleteAllBtn.addEventListener('click', async function() {
            if (confirm('Are you sure you want to empty your cart?')) {
                try {
                    // UPDATED: Uses DELETE /carts
                    const response = await fetch(API_URL, {
                        method: 'DELETE',
                        credentials: 'include'
                    });

                    if (response.ok) {
                        fetchCart(); // Reload the cart
                    } else {
                        showError('Failed to clear cart.');
                    }
                } catch (error) {
                    showError('Connection error.');
                }
            }
        });

        // "Checkout" button
        checkoutBtn.addEventListener('click', function() {
            window.location.href = '/checkout.html'; // Assumes a static checkout page
        });

        // --- (Helper functions for messages are the same) ---
        function showError(message) {
            errorMsg.textContent = message;
            errorMsg.style.display = 'block';
        }
        function showSuccess(message) {
            successMsg.firstChild.nodeValue = message; // Set text
            successMsg.style.display = 'block';
        }

        // --- Initial Load ---
        fetchCart();
    });
</script>
</body>
</html>