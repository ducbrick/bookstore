<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Book Store - Admin</title>
    <link href="images/logo.png" rel="shortcut icon" />
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous" />
    <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous" />
    <link href="css/style.css" rel="stylesheet" />
    <script src="js/config.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
</head>

<body>
<nav class="navbar navbar-dark bg-dark">
    <a class="navbar-brand" href="/">Book Store</a>
    <a class="navbar-brand" href="/cart.html">Cart</a>
    <a class="navbar-brand" href="/list.html">Admin</a>
</nav>

<div class="container" id="main-content">
    <div class="row">
        <div class="col-3 no-padding">
            <form class="form-inline" id="search-form">
                <input class="form-control mr-sm-2" type="search" id="search-term" name="term"
                       placeholder="Search by name ..." />
                <button class="btn btn-primary" type="submit">
                    <i class="fa fa-search"></i> Search
                </button>
            </form>
        </div>
        <div class="col-3 no-padding">
            <a href="/form.html" class="btn btn-success float-right">
                <i class="fa fa-plus-square"></i> New book
            </a>
        </div>
        <div class="col-3 no-padding">
            <a href="/orders.html" class="btn btn-info float-right">
                <i class="fa fa-list-ul"></i> Orders
            </a>
        </div>
        <div class="col-3 no-padding">
            <button id="logout-btn" class="btn btn-danger float-right">
                <i class="fa fa-key"></i> Log out
            </button>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12 alert alert-success alert-dismissible fade show" role="alert" id="success-message" style="display: none;">
            <span id="success-text"></span>
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <div class="col-12 alert alert-danger" role="alert" id="error-message" style="display: none;"></div>

        <div id="no-books-message" style="display: none;">
            <h5>There are no books in stock</h5>
        </div>

        <th:block>
            <div class="table-responsive">
                <h5>List of books</h5>
                <table class="table table-striped table-dark text-nowrap">
                    <thead>
                    <tr>
                        <th>Name</th>
                        <th>Authors</th>
                        <th>Publisher</th>
                        <th>Published on</th>
                        <th>ISBN</th>
                        <th>Price ($)</th>
                        <th>Action</th>
                    </tr>
                    </thead>
                    <tbody id="book-table-body">
                    </tbody>
                </table>
                <h5>&nbsp;</h5>
            </div>

            <nav aria-label="Page navigation">
                <ul class="pagination" id="pagination-container">
                </ul>
            </nav>
        </th:block>
    </div>
</div>

<footer class="container" style="padding: 50px;">
    <strong>&copy; <a href="https://github.com/crni99/" target="_blank">github/crni99</a></strong>
</footer>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const bookTableBody = document.getElementById('book-table-body');
        const paginationContainer = document.getElementById('pagination-container');
        const searchForm = document.getElementById('search-form');
        const searchTermInput = document.getElementById('search-term');
        const noBooksMsg = document.getElementById('no-books-message');
        const successMsg = document.getElementById('success-message');
        const successText = document.getElementById('success-text');
        const errorMsg = document.getElementById('error-message');
        const logoutBtn = document.getElementById('logout-btn');

        // API Endpoint
        const API_URL = window.APP_CONFIG.BACKEND_URL + '/api/books';

        // --- 1. Main Function: Fetch and Render Books ---
        async function fetchBooks(page = 0, size = 10, term = '') {
            bookTableBody.innerHTML = '';
            paginationContainer.innerHTML = '';
            noBooksMsg.style.display = 'none';
            successMsg.style.display = 'none';
            errorMsg.style.display = 'none';

            const url = new URL(API_URL);
            url.searchParams.append('page', page);
            url.searchParams.append('size', size);
            if (term) {
                url.searchParams.append('term', term);
            }

            try {
                const response = await fetch(url.toString(), {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const bookPage = await response.json();
                    if (bookPage && bookPage.content && bookPage.content.length > 0) {
                        renderBookTable(bookPage.content);
                        renderPagination(bookPage);
                    } else {
                        noBooksMsg.style.display = 'block';
                    }
                } else {
                    showError('Could not load books.');
                }
            } catch (error) {
                showError('Could not connect to the server.');
            }
        }

        // --- 2. Helper: Render Book Table ---
        function renderBookTable(books) {
            books.forEach(book => {
                const row = `
                    <tr>
                         <td>${book.name || ''}</td>
                         <td>${book.authors || ''}</td>
                         <td>${book.publisher || ''}</td>
                         <td>${book.publishedOn || ''}</td>
                         <td>${book.isbn || ''}</td>
                         <td>${book.price || ''}</td>
                         <td>
                            <a href="/form.html?id=${book.id}" class="mr-sm-2 text-primary">
                                <i class="fa fa-pencil fa-bigger"></i>
                            </a>
                            <a href="#" class="delete-btn text-danger" data-book-id="${book.id}">
                                <i class="fa fa-trash fa-bigger"></i>
                            </a>
                         </td>
                      </tr>
                `;
                bookTableBody.innerHTML += row;
            });
        }

        // --- 3. Helper: Render Pagination (Same as index.html) ---
        function renderPagination(bookPage) {
            if (bookPage.totalPages <= 1) return;

            for (let i = 0; i < bookPage.totalPages; i++) {
                const pageNum = i;
                const li = document.createElement('li');
                li.className = `page-item font-weight-bold ${pageNum === bookPage.number ? 'active' : ''}`;

                const a = document.createElement('a');
                a.className = 'page-link';
                a.href = '#';
                a.textContent = pageNum + 1;
                a.dataset.page = pageNum;

                li.appendChild(a);
                paginationContainer.appendChild(li);
            }
        }

        // --- 4. Event Listeners ---

        // Search
        searchForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const term = searchTermInput.value;
            fetchBooks(0, 10, term);
        });

        // Pagination
        paginationContainer.addEventListener('click', function(e) {
            e.preventDefault();
            if (e.target.tagName === 'A' && e.target.dataset.page) {
                const page = e.target.dataset.page;
                const term = searchTermInput.value;
                fetchBooks(page, 10, term);
            }
        });

        // Delete (uses Event Delegation)
        bookTableBody.addEventListener('click', async function(e) {
            const deleteBtn = e.target.closest('.delete-btn');
            if (deleteBtn) {
                e.preventDefault();
                const bookId = deleteBtn.dataset.bookId;

                if (confirm('Are you sure you want to delete this book?')) {
                    try {
                        const response = await fetch(`${API_URL}/${bookId}`, {
                            method: 'DELETE',
                            credentials: 'include'
                            // Add CSRF header if needed
                        });

                        if (response.ok) {
                            showSuccess('Book deleted successfully.');
                            fetchBooks(0, 10, searchTermInput.value); // Reload current view
                        } else {
                            showError('Failed to delete book.');
                        }
                    } catch (error) {
                        showError('Connection error.');
                    }
                }
            }
        });

        // Logout
        logoutBtn.addEventListener('click', async function() {
            try {
                // Spring Security's default logout is POST /logout
                const response = await fetch(window.APP_CONFIG.BACKEND_URL + '/logout', {
                    method: 'POST',
                    credentials: 'include'
                    // Add CSRF header if needed
                });

                if (response.ok) {
                    window.location.href = '/login.html'; // Redirect to login
                } else {
                    showError('Logout failed.');
                }
            } catch (error) {
                showError('Connection error during logout.');
            }
        });

        // --- Helper functions for messages ---
        function showError(message) {
            errorMsg.textContent = message;
            errorMsg.style.display = 'block';
        }
        function showSuccess(message) {
            successText.textContent = message;
            successMsg.style.display = 'block';
        }

        // --- Initial Load ---
        fetchBooks(0, 10); // Load first page, 10 items
    });
</script>
</body>
</html>